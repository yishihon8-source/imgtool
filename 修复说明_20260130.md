# ✅ 两个问题已修复！

## 修复日期：2026-01-30

---

## 🔧 修复内容

### 问题1：添加文件夹时直接打开"此电脑"

**修复前**：点击"添加文件夹"按钮，文件夹选择对话框默认打开到"桌面"或其他位置。

**修复后**：点击"添加文件夹"按钮，文件夹选择对话框默认打开到**"此电脑"**，方便用户直接选择任意磁盘。

**技术实现**：
- 添加了 `BrowseCallbackProc` 回调函数
- 使用 `BFFM_INITIALIZED` 消息设置初始路径
- 使用 `CSIDL_DRIVES` 定位到"此电脑"

```cpp
int CALLBACK BrowseCallbackProc(HWND hwnd, UINT uMsg, LPARAM lParam, LPARAM lpData) {
    if (uMsg == BFFM_INITIALIZED) {
        LPITEMIDLIST pidl;
        if (SUCCEEDED(SHGetSpecialFolderLocation(hwnd, CSIDL_DRIVES, &pidl))) {
            SendMessage(hwnd, BFFM_SETSELECTION, FALSE, (LPARAM)pidl);
            CoTaskMemFree(pidl);
        }
    }
    return 0;
}
```

---

### 问题2：拉伸图片下边缘时，上边缘也会移动

**修复前**：
- 用户拖拽图片下边缘的中点时，图片上边缘也会跟着移动
- 所有控制点都使用"从中心缩放"的方式

**修复后**：
- 拖拽下边缘中点时，**上边缘固定不动**（锚点在上边缘）
- 拖拽上边缘中点时，**下边缘固定不动**（锚点在下边缘）
- 拖拽左边缘中点时，**右边缘固定不动**（锚点在右边缘）
- 拖拽右边缘中点时，**左边缘固定不动**（锚点在左边缘）
- 拖拽四个角点时，**对角固定不动**（等比例缩放）

**技术实现**：
- 为每个控制点设置不同的锚点（固定点）
- 边缘中点只缩放单轴（宽度或高度）
- 角点进行等比例缩放
- 根据锚点位置调整图片位置，保持锚点固定

```cpp
// 示例：拉伸下边缘中点
case TransformHandle::BottomCenter:
    anchor = ImVec2(centerPos.x, imageMin.y);  // 顶边中心固定
    useProportional = false;  // 只缩放高度
    break;
```

---

## 📦 新版本位置

```
F:\oneDrive\Desktop\ps-cpp\build_release\bin\Release\ImageBatchTool.exe
```

**请手动复制到发布目录**：
```
F:\oneDrive\Desktop\ps-cpp\发布版本\图片批处理工具.exe
```

---

## 🧪 测试建议

### 测试1：文件夹选择
1. 运行程序
2. 点击"添加文件夹"按钮
3. 验证对话框是否打开到"此电脑"
4. 选择任意磁盘的文件夹

### 测试2：图片拉伸锚点
1. 导入一张图片
2. 按 `Ctrl+T` 进入变换模式
3. 拖拽**下边缘中点**向下拉伸
4. 验证**上边缘是否固定不动**
5. 拖拽**右边缘中点**向右拉伸
6. 验证**左边缘是否固定不动**
7. 拖拽**右下角**进行等比例缩放
8. 验证**左上角是否固定不动**

---

## 📝 修改的文件

### 1. `src/utils/FileDialog.cpp`
- 添加了 `BrowseCallbackProc` 回调函数
- 修改了 `OpenFolder()` 函数，设置默认路径为"此电脑"

### 2. `src/ui/PreviewPanel.cpp`
- 修改了 `HandleTransformInput()` 函数
- 为每个控制点设置不同的锚点
- 实现了单轴缩放（边缘中点）
- 实现了等比例缩放（角点）
- 添加了位置补偿逻辑，保持锚点固定

---

## 🎯 控制点说明

```
┌─────────┬─────────┬─────────┐
│  左上角  │  上中点  │  右上角  │
│ (对角固定)│ (下固定) │ (对角固定)│
├─────────┼─────────┼─────────┤
│  左中点  │   中心   │  右中点  │
│ (右固定) │  (移动)  │ (左固定) │
├─────────┼─────────┼─────────┤
│  左下角  │  下中点  │  右下角  │
│ (对角固定)│ (上固定) │ (对角固定)│
└─────────┴─────────┴─────────┘
```

- **角点**：等比例缩放，对角固定
- **边中点**：单轴缩放，对边固定
- **中心**：移动图片

---

## ✅ 完成状态

- ✅ 问题1：文件夹选择默认打开"此电脑"
- ✅ 问题2：拉伸锚点修复（上边缘固定）
- ✅ 编译成功
- ⏳ 需要手动复制到发布目录

---

**现在可以测试新功能了！** 🚀



